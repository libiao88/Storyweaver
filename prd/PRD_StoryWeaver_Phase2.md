# 需求规格说明书：StoryWeaver AI (智语拆解) - 第二期

**版本**: 2.0  
**日期**: 2026-01-28  
**状态**: 规划中

---

## 1. 修订记录 (Revision History)

| 版本 | 日期 | 修订内容 | 修订人 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| v1.0 | 2026-01-25 | 初始版本 (Phase 1: 核心拆解能力) | SW-Team | 已发布 |
| v2.0 | 2026-01-28 | 第二期需求规划：故事地图、Figma 审计、接口生成 | Trae AI | 规划中 |
| v2.1 | 2026-01-29 | 新增功能：自动化同步至飞书 (Lark) Wiki | Trae AI | 已开发 |

---

## 2. 项目概述 (Project Overview)

### 2.1 项目背景
在第一期（Phase 1）中，StoryWeaver AI 实现了从 PRD 文档到标准用户故事（User Stories）的自动化转化。然而，在实际的敏捷开发流程中，仅有独立的故事列表是不够的。产品经理仍需手动规划迭代排期，UI 设计师与 PM 之间仍存在设计与需求的一致性核对成本，而开发人员则需要根据设计和需求手动编写接口文档。

### 2.2 二期目标
第二期（Phase 2）旨在打通“需求 - 设计 - 开发”的自动化闭环，通过引入可视化规划、智能审计和自动代码/文档生成能力，进一步提升团队协同效率。

### 2.3 目标用户
*   **产品经理 (PM)**：需要自动化的迭代规划工具，确保需求与设计的一致性。
*   **UI/UX 设计师**：需要快速验证设计稿是否覆盖了所有功能需求。
*   **开发工程师 (Dev)**：需要根据需求和设计快速生成 API 规范，减少重复劳动。

### 2.4 核心价值主张
*   **规划自动化**：从静态故事列表进化为动态的、具备逻辑支撑的用户故事地图。
*   **设计一致性**：通过智能审计，消除设计与需求之间的“灰色地带”。
*   **开发前置化**：在设计完成阶段即可自动产出初步的 API 协议，加速前后端并行开发。

---

## 3. 功能需求详述 (Functional Requirements)

### 3.1 自动用户故事地图规划与制作 (P0)
*   **需求描述**：
    该模块能够将一期生成的离散用户故事（User Stories）转化为具备时间维度和逻辑层级的“故事地图”。系统基于算法自动建议迭代（Sprint）和发布（Release）计划。
*   **功能规格**：
    *   **数据导入与输入**：
        *   支持从一期解析结果中直接导入。
        *   支持手动录入结构化故事数据（标题、描述、角色、验收标准、优先级 P0-P2、估算点数 Story Points、依赖 ID）。
    *   **智能规划引擎**：
        *   **优先级排序**：基于 MoSCoW 原则（Must, Should, Could, Won't）或数值优先级。
        *   **依赖识别**：识别故事间的阻塞关系（Blocking Relations）。
        *   **排期建议**：根据团队设定的 Velocity（迭代容量）和优先级，自动将故事分配至不同的 Release 和 Sprint。
    *   **可视化交互视图**：
        *   **四级结构展示**：骨干（Activities）-> 任务（Tasks）-> 故事（Stories）-> 细节（Acceptance Criteria）。
        *   **拖拽操作**：支持用户在地图中通过拖拽调整故事所属的 Sprint 或优先级，系统实时重计算排期影响。
        *   **发布线（Release Lines）**：在视图中清晰标记不同版本的交付边界。
    *   **导出能力**：
        *   **视觉格式**：支持导出为 PNG 或 SVG 图片，用于 PPT 汇报。
        *   **数据格式**：支持导出为 JSON 或 Excel，用于导入 Jira 或其他协作工具。
*   **验收标准**：
    *   **逻辑准确性**：自动排期结果必须满足“高优先级优先”且“依赖项在前”的逻辑。
    *   **性能**：地图视图加载及拖拽操作响应时间 < 2秒。
    *   **完整性**：导出的数据文件必须包含地图的所有层级和排期信息。

### 3.2 Figma 设计稿与 PRD 内容智能匹配与审计 (P1)
*   **需求描述**：
    通过将 Figma 设计稿与 PRD 文档进行语义对齐，自动发现设计遗漏、多余设计或逻辑不一致问题。
*   **功能规格**：
    *   **Figma 数据集成**：
        *   支持输入 Figma File URL（通过个人访问令牌 PAT 授权）。
        *   提取 Frames, Components, Text Layers, Layers Hierarchy 等元数据。
    *   **语义比对模型**：
        *   利用 NLP 技术将 PRD 中的“功能点描述”与 Figma 中的“画板名称/文字内容”进行映射。
        *   建立 UI 组件（如 Button, Input）与 PRD 中“交互操作”的关联。
    *   **审计报告生成**：
        *   **遗漏项检测**：PRD 提及的功能页面，在 Figma 中未找到对应画板。
        *   **冗余项检测**：Figma 中存在复杂页面，但 PRD 中无对应需求描述。
        *   **歧义检测**：例如 PRD 描述“搜索框在顶部”，设计稿却放在了侧边栏。
    *   **交互式定位**：
        *   在报告中点击问题项，可联动打开预览窗口并定位到具体的 Figma 节点和 PRD 段落。
*   **验收标准**：
    *   **解析能力**：成功解析包含至少 100 个节点的复杂 Figma 文件。
    *   **准确率**：审计报告发现的有效问题（True Positives）占比不低于 85%。
    *   **时效性**：中型项目（约 50 个画板）的审计耗时 < 5 分钟。

### 3.3 基于 PRD 与 Figma 设计稿的接口文档自动生成 (P2)
*   **需求描述**：
    综合 PRD 的业务逻辑与 Figma 的 UI 结构，自动推导出前后端交互所需的 API 接口文档草案。
*   **功能规格**：
    *   **业务实体识别**：从 PRD 文本中提取核心名词（如：User, Order, Token）作为 API 的数据模型（Schemas）。
    *   **UI 字段推导**：
        *   分析 Figma 里的表单（Form）组件，推导出 `POST/PUT` 请求的 Request Body 字段。
        *   分析列表（List/Table）组件，推导出 `GET` 请求的 Response Body 字段。
    *   **OpenAPI 3.0 适配**：
        *   自动生成标准的 Swagger YAML/JSON。
        *   定义 Path, Method, Parameters, Responses, Headers。
    *   **预览与编辑**：
        *   提供 Web 端 Swagger UI 预览。
        *   允许开发人员在线微调推导出的字段类型或描述。
*   **验收标准**：
    *   **覆盖度**：生成的接口应覆盖 PRD 中描述的 90% 以上的数据交互场景。
    *   **规范性**：导出的 YAML 文件必须通过 Swagger Editor 的标准校验。
    *   **一致性**：生成的字段名称应与 Figma 中的文本标签或组件名称具有语义一致性。

### 3.4 自动化同步至飞书 Wiki (Lark Wiki Sync) (P1)
*   **需求描述**：
    实现将 StoryWeaver 拆解完成的用户故事自动上传并同步至飞书 (Lark) Wiki 知识库，打通需求到文档管理的最后一公里。
*   **功能规格**：
    *   **Lark 开放平台集成**：
        *   支持 OAuth2.0 授权流程，确保应用具备 Wiki 节点的读取与写入权限。
        *   支持配置 App ID 和 App Secret (加密存储)。
    *   **同步流程控制**：
        *   **触发方式**：支持拆解完成后自动触发，或在故事列表页手动批量/单条触发。
        *   **字段映射引擎**：自动将 Story 的 Title, Description, Acceptance Criteria, Priority 映射为 Wiki 页面的标题和正文结构（支持 Markdown 转富文本）。
    *   **规则配置管理**：
        *   **目标定位**：允许用户选择目标 Wiki 空间 (Space) 及父页面 (Parent Node)。
        *   **模板配置**：支持自定义 Wiki 页面模板（如插入标准的需求元数据表格）。
        *   **命名规范**：支持配置页面标题前缀（如 `[Story] `）及日期后缀。
        *   **版本控制**：若检测到同名页面，支持选择“覆盖更新”、“创建新版本”或“跳过”。
    *   **异常处理与通知**：
        *   **重试机制**：对网络抖动或 API 限流（Rate Limit）导致的失败进行自动重试（默认 3 次）。
        *   **失败日志**：记录详细的失败原因（如权限不足、参数错误），支持手动重新触发失败任务。
        *   **结果通知**：支持配置飞书群机器人 Webhook 或邮件通知，发送同步结果报告。
    *   **管理与测试**：
        *   **配置界面**：提供全局开关、字段映射自定义、频率限制设置（如 10次/分钟）。
        *   **测试模式 (Dry Run)**：支持仅预览同步后的页面结构而不实际创建 Wiki 页面。
*   **验收标准**：
    *   **认证连通性**：OAuth2.0 授权流程顺畅，Token 自动刷新。
    *   **内容准确性**：同步后的 Wiki 页面格式清晰，所有关键字段（标题、验收标准）无缺失。
    *   **稳定性**：在 API 限流或网络异常时，系统能正确捕获错误并执行重试或报错，不导致程序崩溃。
    *   **性能指标**：单次上传操作（包含 API 调用）平均耗时 < 2秒。

---

## 4. 非功能性需求 (Non-Functional Requirements)

### 4.1 性能 (Performance)
*   **故事地图渲染**：支持同时展示 200+ 个故事节点，首屏渲染时间 < 1.5 秒。
*   **Figma 解析**：Figma 节点提取与缓存机制需确保重复审计时的响应时间 < 30 秒。
*   **并发能力**：后端支持 50 个并发的 API 文档生成请求。

### 4.2 安全性与合规性 (Security)
*   **授权管理**：
    *   Figma Access Token 必须加密存储，且支持用户随时撤销授权。
    *   Lark App Secret 必须采用 AES-256 加密存储，禁止明文保存。
*   **数据隐私**：审计过程中提取的 Figma 设计稿元数据仅在内存中处理，不进行永久落盘。
*   **审计日志**：记录所有 API 导出、计划修改及 Wiki 同步的操作日志。

### 4.3 兼容性 (Compatibility)
*   **Figma 版本**：支持 Figma REST API v1 及以上版本。
*   **浏览器**：完美支持 Chrome, Edge, Safari 等主流浏览器（针对 Flutter Web）。

---

## 5. 项目里程碑与工作量估算 (Milestones & Estimation)

### 5.1 迭代规划
*   **Iteration 2.1 (2周)**：
    *   核心：自动故事地图逻辑算法与前端可视化组件开发。
    *   交付：可交互的故事地图 Beta 版。
*   **Iteration 2.2 (2周)**：
    *   核心：Figma API 集成与 LLM 语义匹配引擎开发。
    *   交付：设计-需求一致性审计报告功能。
*   **Iteration 2.3 (2周)**：
    *   核心：API 文档自动生成与 OpenAPI 导出功能；Lark Wiki 同步模块。
    *   交付：完整的 Phase 2 功能闭环（含文档与 Wiki 同步）。

### 5.2 工作量估算 (初步)
| 模块 | 研发工时 (人天) | 优先级 |
| :--- | :--- | :--- |
| 自动故事地图引擎 (Frontend + Backend) | 15 | P0 |
| Figma API 集成与审计算法 | 12 | P1 |
| API 文档推导与 OpenAPI 适配 | 8 | P2 |
| Lark Wiki 自动化同步集成 | 8 | P1 |

---

## 6. 风险评估与缓解策略 (Risks & Mitigations)

| 风险项 | 影响程度 | 缓解策略 |
| :--- | :--- | :--- |
| Figma 文档结构过于复杂导致解析失败 | 高 | 预设标准组件命名规范建议；提供手动映射补救机制。 |
| LLM 语义匹配存在误报或漏报 | 中 | 引入“置信度”分值；允许用户在报告中标记“忽略”或“已确认”。 |
| 自动生成的 API 字段与实际开发习惯不符 | 中 | 提供灵活的模板配置；允许在预览阶段进行批量重命名。 |
| Lark API 接口变动或限流 | 中 | 封装统一的 API Client 层以隔离变更；实现指数退避重试算法。 |

---

## 7. 成功标准 (Success Metrics)
1.  **规划效率**：用户从故事列表生成完整地图并完成首次排期的时间 < 10 分钟。
2.  **审计准确率**：设计遗漏识别准确率达 85% 以上。
3.  **开发加速**：前端开发人员使用自动生成的 API 草案，可减少 50% 的接口定义沟通时间。
